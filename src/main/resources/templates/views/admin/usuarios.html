<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>GESTIÓN DE USUARIOS - SOLUCIONES MUSICALES</title>

    <link th:href="@{/assets/css/styles.css}" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

<div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

<header>
    <a th:href="@{/}">
        <img th:src="@{/assets/img/logo.png}" alt="logo soluciones musicales" class="logo">
    </a>

    <div class="iconos">

        <!-- ICONO CARRITO -->
        <a th:href="@{/carrito}">
            <img th:src="@{/assets/img/carrito.png}" alt="logo carrito" class="logo">
        </a>

        <!-- ADMIN -->
        <a th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}"
           th:href="@{/paneladmin}">
            <img th:src="@{/assets/img/user.png}" alt="logo user" class="logo">
        </a>

        <!-- USUARIO LOGUEADO NORMAL -->
        <a th:if="${#authorization.expression('isAuthenticated()')
               and !#authorization.expression('hasRole(''ROLE_ADMIN'')')}"
           th:href="@{/inicio}">
            <img th:src="@{/assets/img/user.png}" alt="logo user" class="logo">
        </a>

        <!-- USUARIO INVITADO (ANÓNIMO) -->
        <a sec:authorize="isAnonymous()" th:href="@{/inicio}">
            <img th:src="@{/assets/img/user.png}" alt="logo user" class="logo">
        </a>

    </div>

    <div class="somos">
        <a th:href="@{/somos}">
            <h5>¿Quiénes somos?</h5>
        </a>
    </div>
</header>

<nav class="menu">
    <div class="btn-group">
        <button class="btn btn-secondary btn-lg dropdown-toggle" type="button" data-bs-toggle="dropdown">
            GUITARRAS ELÉCTRICAS
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" th:href="@{/catalogos/guitarras/fender}">FENDER</a></li>
            <li><a class="dropdown-item" th:href="@{/catalogos/guitarras/gibson}">GIBSON</a></li>
            <li><a class="dropdown-item" th:href="@{/catalogos/guitarras/schecter}">SCHECTER</a></li>
        </ul>
    </div>

    <div class="btn-group">
        <button class="btn btn-secondary btn-lg dropdown-toggle" type="button" data-bs-toggle="dropdown">
            BAJOS ELÉCTRICOS
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" th:href="@{/catalogos/bajos/fender}">FENDER</a></li>
            <li><a class="dropdown-item" th:href="@{/catalogos/bajos/ibanez}">IBANEZ</a></li>
            <li><a class="dropdown-item" th:href="@{/catalogos/bajos/schecter}">SCHECTER</a></li>
        </ul>
    </div>
</nav>


<div class="container admin-container mt-4">
    <h1>Gestión de Usuarios</h1>
    <p class="lead">Listado completo de usuarios registrados.</p>

    <a th:href="@{/paneladmin}" class="btn btn-secondary mb-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
             fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M15 8a.5.5..." />
        </svg>
        Volver al Panel Principal
    </a>

    <!-- ALERTAS -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
        <strong>¡Éxito!</strong> <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <strong>¡Error!</strong> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <h2 class="mt-4">Lista de Usuarios</h2>

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Acciones</th>
            </tr>
            </thead>

            <tbody>

            <!-- Obtener usuario actual -->
            <span sec:authentication="name" th:id="'currentUser'"></span>

            <!-- LISTA DE USUARIOS -->
            <tr th:each="usuario : ${usuarios}">
                <td th:text="${usuario.id}"></td>

                <td>
                    <span th:text="${usuario.username}"></span>

                    <span class="badge text-bg-primary ms-2"
                          th:if="${#authentication.name == usuario.username}">
                        USUARIO ACTUAL
                    </span>
                </td>

                <td th:text="${usuario.email}"></td>

                <td>
                    <span th:text="${usuario.rol}"></span>

                    <span class="badge text-bg-danger ms-2"
                          th:if="${usuario.rol == 'ADMIN' and #authentication.name != usuario.username}">
                        ADMIN
                    </span>
                </td>

                <td>

                    <!-- Si es el usuario actual -->
                    <span th:if="${usuario.username == #authentication.name}"
                          class="badge text-bg-secondary p-2">
                        Protegido (Self)
                    </span>

                    <!-- Si es administrador -->
                    <span th:if="${usuario.rol == 'ADMIN' and usuario.username != #authentication.name}"
                          class="badge text-bg-secondary p-2">
                        Protegido (Admin)
                    </span>

                    <!-- Acciones normales -->
                    <span th:if="${usuario.rol != 'ADMIN' and usuario.username != #authentication.name}">
                        <a th:href="@{'/paneladmin/usuarios/editar/' + ${usuario.id}}"
                           class="btn btn-sm btn-warning text-dark me-2">Editar</a>

                        <a th:href="@{'/paneladmin/usuarios/eliminar/' + ${usuario.id}}"
                           onclick="return confirm('¿Está seguro de eliminar al usuario?')"
                           class="btn btn-sm btn-danger">Eliminar</a>
                    </span>

                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(usuarios)}">
                <td colspan="5" class="text-center">
                    No hay usuarios registrados.
                </td>
            </tr>

            </tbody>
        </table>
    </div>
</div>


<footer class="bg-dark text-light mt-5 p-4">
    <div class="container">
        <div class="row">

            <div class="col-md-4">
                <h5>SOLUCIONES MUSICALES</h5>
                <p>Tu tienda de confianza en guitarras y bajos.</p>
            </div>

            <div class="col-md-4">
                <h5>Contacto</h5>
                <ul class="list-unstyled">
                    <li>+57 300 123 4567</li>
                    <li>contacto@solucionesmusicales.com</li>
                    <li>Neiva, Huila, Colombia</li>
                </ul>
            </div>

            <div class="col-md-4">
                <h5>Enlaces</h5>
                <ul class="list-unstyled">
                    <li><a th:href="@{/somos}" class="text-light text-decoration-none">Quiénes somos</a></li>
                    <li><a class="text-light text-decoration-none">Guitarras</a></li>
                    <li><a class="text-light text-decoration-none">Bajos</a></li>
                    <li><a class="text-light text-decoration-none">Contacto</a></li>
                </ul>
            </div>

        </div>

        <hr class="border-light">
        <p class="text-center mb-0">&copy; 2025 Soluciones Musicales - Todos los derechos reservados</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
